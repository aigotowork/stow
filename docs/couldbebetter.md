# è®¾è®¡åæ€ä¸æ”¹è¿›å»ºè®®

æœ¬æ–‡æ¡£è®°å½• Stow é¡¹ç›®ä¸­**å¯ä»¥åšå¾—æ›´å¥½**çš„è®¾è®¡å†³ç­–ï¼Œä»¥åŠç»è¿‡æ·±æ€ç†Ÿè™‘çš„æ”¹è¿›å»ºè®®ã€‚

## åæ€åŸåˆ™

1. **ä¸ç›²ç›®ä¼˜åŒ–** - æ”¹è¿›å¿…é¡»æœ‰æ˜ç¡®æ”¶ç›Š
2. **æƒè¡¡æ¸…æ™°** - è¯´æ˜ä¸ºä»€ä¹ˆå½“å‰è®¾è®¡ä¸å¤Ÿå¥½
3. **å¯è¡Œæ€§è€ƒè™‘** - æ”¹è¿›æ–¹æ¡ˆå¿…é¡»å¯å®æ–½
4. **å‘åå…¼å®¹** - ä¼˜å…ˆè€ƒè™‘å…¼å®¹æ€§

---

## Core æ¨¡å—

### é—®é¢˜ 1ï¼šåå‘è¯»å–æ•ˆç‡ä½ä¸‹ âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
// è¯»å–æ‰€æœ‰è¡Œåˆ°å†…å­˜
var lines [][]byte
for scanner.Scan() {
    line := make([]byte, len(scanner.Bytes()))
    copy(line, scanner.Bytes())
    lines = append(lines, line)
}

// åå‘éå†
for i := len(lines) - 1; i >= 0; i-- {
    ...
}
```

**é—®é¢˜ï¼š**
- âŒ å¿…é¡»è¯»å–å®Œæ•´æ–‡ä»¶ï¼ˆå³ä½¿åªéœ€è¦æœ€åä¸€è¡Œï¼‰
- âŒ å†…å­˜å ç”¨ = æ–‡ä»¶å¤§å°
- âŒ å¤§æ–‡ä»¶ï¼ˆ> 100MBï¼‰å¯èƒ½ OOM

**å½±å“åœºæ™¯ï¼š**
- å†å²ç‰ˆæœ¬å¤šï¼ˆ> 1000 æ¡ï¼‰
- æ–‡ä»¶å¤§ï¼ˆ> 10MBï¼‰

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼š** ä»æ–‡ä»¶æœ«å°¾å‘å‰æœç´¢ï¼ˆæ¨èï¼‰â­

```go
func ReadLastValidReverse(filePath string) (*Record, error) {
    f, _ := os.Open(filePath)
    defer f.Close()

    // 1. å®šä½åˆ°æ–‡ä»¶æœ«å°¾
    stat, _ := f.Stat()
    size := stat.Size()

    // 2. ä»æœ«å°¾å‘å‰è¯»å–å—
    buf := make([]byte, 4096)
    pos := size

    for pos > 0 {
        // è¯»å–å—
        readSize := min(4096, pos)
        pos -= readSize
        f.ReadAt(buf[:readSize], pos)

        // æŸ¥æ‰¾æœ€åä¸€ä¸ªæ¢è¡Œç¬¦
        for i := readSize - 1; i >= 0; i-- {
            if buf[i] == '\n' {
                // æ‰¾åˆ°ä¸€è¡Œï¼Œè§£ç 
                line := buf[i+1:readSize]
                record, err := Decode(line)
                if err == nil && record.Meta.IsPut() {
                    return record, nil
                }
            }
        }
    }

    return nil, nil
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… å†…å­˜å ç”¨å›ºå®šï¼ˆ4KBï¼‰
- âœ… å¹³å‡æƒ…å†µï¼šåªè¯»å–æœ€åä¸€ä¸ªå—
- âœ… æœ€åæƒ…å†µï¼šO(æ–‡ä»¶å¤§å°)ï¼Œä½†ä¸å å†…å­˜

**åŠ£åŠ¿ï¼š**
- å®ç°å¤æ‚ï¼ˆè·¨å—è¡Œå¤„ç†ï¼‰
- éœ€è¦å¤„ç†ä¸å®Œæ•´è¡Œ

**æ”¶ç›Šè¯„ä¼°ï¼š**
```
åœºæ™¯ï¼š1000 è¡Œï¼Œæ¯è¡Œ 1KBï¼Œæ–‡ä»¶ 1MB
å½“å‰ï¼šè¯»å– 1MB å†…å­˜
æ”¹è¿›ï¼šè¯»å– 4KB å†…å­˜ï¼ˆ250x æ”¹è¿›ï¼‰
```

**æ–¹æ¡ˆ Bï¼š** å°¾éƒ¨ç´¢å¼•ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰

```go
// åœ¨æ–‡ä»¶æœ«å°¾ç»´æŠ¤ç´¢å¼•
{
    "_meta": {...},
    "data": {...}
}
...
{"_index": {"lastValidLine": 999}}  # æœ€åä¸€è¡Œæ˜¯ç´¢å¼•
```

**ä¼˜åŠ¿ï¼š**
- âœ… O(1) æŸ¥æ‰¾
- âœ… æ— éœ€æ‰«ææ–‡ä»¶

**åŠ£åŠ¿ï¼š**
- âŒ ç ´å JSONL æ ¼å¼çº¯ç²¹æ€§
- âŒ å¤–éƒ¨ç¼–è¾‘ä¼šç ´åç´¢å¼•
- âŒ å¢åŠ å†™å…¥å¤æ‚åº¦

**å»ºè®®ï¼š** é‡‡ç”¨æ–¹æ¡ˆ Aï¼ˆå‘å‰æœç´¢ï¼‰ï¼Œå¹³è¡¡æ€§èƒ½å’Œç®€æ´æ€§ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- å®ç°äº† `ReadLastValidReverse()` æ–¹æ³•
- ä½¿ç”¨ 4KB å—ä»æ–‡ä»¶æœ«å°¾å‘å‰è¯»å–
- å†…å­˜å ç”¨ä» O(æ–‡ä»¶å¤§å°) é™è‡³ O(4KB Ã— è¿­ä»£æ¬¡æ•°)
- æµ‹è¯•é€šè¿‡ï¼šinternal/core åŒ… 14 tests passing

---

### é—®é¢˜ 2ï¼šç‰ˆæœ¬å·ç®¡ç†ä¸å¤Ÿé²æ£’

**å½“å‰è®¾è®¡ï¼š**
```go
// è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
func getNextVersion(filePath string) int {
    latest, _ := decoder.GetLatestVersion(filePath)
    return latest + 1
}
```

**é—®é¢˜ï¼š**
- âŒ å¹¶å‘ Put å¯èƒ½äº§ç”Ÿé‡å¤ç‰ˆæœ¬å·
- âŒ æ–‡ä»¶æŸåæ—¶ç‰ˆæœ¬å·å¯èƒ½å€’é€€

**æ”¹è¿›æ–¹æ¡ˆï¼š**

```go
// ä½¿ç”¨æ—¶é—´æˆ³ + è®¡æ•°å™¨
type Meta struct {
    Key       string    `json:"k"`
    Version   int       `json:"v"`
    Timestamp time.Time `json:"ts"`
    Counter   int64     `json:"c"`  // æ–°å¢ï¼šå•è°ƒé€’å¢
}

func (ns *namespace) getNextVersion() int {
    ns.versionCounter++  // åŸå­é€’å¢
    return int(ns.versionCounter)
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ç‰ˆæœ¬å·ç»å¯¹å•è°ƒ
- âœ… å¹¶å‘å®‰å…¨

**åŠ£åŠ¿ï¼š**
- âŒ éœ€è¦åœ¨ Namespace ä¸­ç»´æŠ¤è®¡æ•°å™¨
- âŒ é‡å¯åéœ€è¦æ‰«ææ¢å¤è®¡æ•°å™¨

**å»ºè®®ï¼š** å½“å‰è®¾è®¡å¯¹å•è¿›ç¨‹è¶³å¤Ÿï¼Œå¤šè¿›ç¨‹åœºæ™¯éœ€æ”¹è¿›ã€‚

---

## Blob æ¨¡å—

### é—®é¢˜ 3ï¼šå»é‡é€»è¾‘ä¸å®Œæ•´ âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
// Store æ–¹æ³•æ£€æŸ¥å»é‡
if m.Exists(&Reference{Location: finalPath}) {
    return existingRef, nil
}
```

**é—®é¢˜ï¼š**
- âŒ åŸºäºæ–‡ä»¶åå»é‡ï¼Œä¸åŸºäºå†…å®¹
- âŒ ç›¸åŒå†…å®¹ã€ä¸åŒæ–‡ä»¶åä¼šåˆ›å»ºå¤šä¸ªæ–‡ä»¶

**ç¤ºä¾‹ï¼š**
```go
// å­˜å‚¨ç›¸åŒå†…å®¹ï¼Œä¸åŒæ–‡ä»¶å
ref1, _ := manager.Store(data, "file1.txt", "text/plain")
// â†’ _blobs/file1_a3f2c1.txt

ref2, _ := manager.Store(data, "file2.txt", "text/plain")
// â†’ _blobs/file2_a3f2c1.txt  ï¼ˆé‡å¤å­˜å‚¨ï¼‰
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼š** å“ˆå¸Œç´¢å¼•ï¼ˆæ¨èï¼‰â­

```go
type Manager struct {
    blobDir   string
    hashIndex map[string]string  // hash â†’ filePath
    mu        sync.RWMutex
}

func (m *Manager) Store(data interface{}, name, mimeType string) (*Reference, error) {
    // 1. è®¡ç®—å“ˆå¸Œ
    hash, size, _ := ComputeSHA256(reader)

    // 2. æ£€æŸ¥å“ˆå¸Œç´¢å¼•
    m.mu.RLock()
    existingPath, exists := m.hashIndex[hash]
    m.mu.RUnlock()

    if exists {
        // è¿”å›ç°æœ‰æ–‡ä»¶çš„å¼•ç”¨
        return &Reference{
            IsBlob:   true,
            Location: existingPath,
            Hash:     hash,
            Size:     size,
            Name:     name,  // å¯ä»¥ç”¨æ–°æ–‡ä»¶å
        }, nil
    }

    // 3. å­˜å‚¨æ–°æ–‡ä»¶
    finalPath := m.generateFileName(name, hash)
    // ... write file ...

    // 4. æ›´æ–°ç´¢å¼•
    m.mu.Lock()
    m.hashIndex[hash] = finalPath
    m.mu.Unlock()

    return ref, nil
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… çœŸæ­£çš„å†…å®¹å»é‡
- âœ… O(1) æŸ¥æ‰¾
- âœ… èŠ‚çœç£ç›˜ç©ºé—´

**åŠ£åŠ¿ï¼š**
- å¯åŠ¨æ—¶éœ€æ‰«ææ‰€æœ‰ Blob æ„å»ºç´¢å¼•
- å†…å­˜å ç”¨ï¼š~64 bytes Ã— Blob æ•°é‡

**æ”¶ç›Šè¯„ä¼°ï¼š**
```
åœºæ™¯ï¼š100 å¼ ç›¸åŒå›¾ç‰‡ï¼Œæ¯å¼  1MB
å½“å‰ï¼š100MB ç£ç›˜
æ”¹è¿›ï¼š1MB ç£ç›˜ï¼ˆ100x èŠ‚çœï¼‰
```

**æ–¹æ¡ˆ Bï¼š** å†…å®¹å¯»å€å­˜å‚¨ï¼ˆCASï¼‰

```go
// æ–‡ä»¶å = å®Œæ•´å“ˆå¸Œ
_blobs/a3f2c1d4e5f6...x0y1z2.bin
```

**ä¼˜åŠ¿ï¼š**
- âœ… å¤©ç„¶å»é‡
- âœ… æ— éœ€é¢å¤–ç´¢å¼•

**åŠ£åŠ¿ï¼š**
- âŒ ä¸¢å¤±åŸå§‹æ–‡ä»¶å
- âŒ æ–‡ä»¶åè¿‡é•¿ï¼ˆ64 å­—ç¬¦ï¼‰

**å»ºè®®ï¼š** é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œæƒè¡¡ç©ºé—´æ•ˆç‡å’Œå¯è¯»æ€§ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- æ·»åŠ äº† `hashIndex map[string]string` å­—æ®µåˆ° BlobManager
- Store() æ–¹æ³•å®ç°å†…å®¹å“ˆå¸Œæ£€æŸ¥ï¼Œé‡ç”¨å·²å­˜åœ¨çš„æ–‡ä»¶
- buildIndex() åŒæ—¶æ„å»ºåç§°ç´¢å¼•å’Œå“ˆå¸Œç´¢å¼•
- æµ‹è¯•é€šè¿‡ï¼šTestBlobDeduplication éªŒè¯å»é‡åŠŸèƒ½
- ç©ºé—´èŠ‚çœï¼šç›¸åŒå†…å®¹åœºæ™¯ä¸‹å¯èŠ‚çœ 100x å­˜å‚¨ç©ºé—´

---

### é—®é¢˜ 4ï¼šGC ç®—æ³•æ•ˆç‡ä½ âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
// O(M + N)ï¼ŒM = JSONL è®°å½•æ•°ï¼ŒN = Blob æ•°é‡
for _, jsonlFile := range allFiles {
    records := readAll(jsonlFile)  // å…¨éƒ¨è¯»å…¥å†…å­˜
    for _, record := range records {
        collectBlobRefs(record.Data, refs)
    }
}
```

**é—®é¢˜ï¼š**
- âŒ è¯»å–æ‰€æœ‰ JSONL æ–‡ä»¶åˆ°å†…å­˜
- âŒ å¤§æ•°æ®é›†ï¼ˆ> 10000 è®°å½•ï¼‰å†…å­˜å ç”¨é«˜

**æ”¹è¿›æ–¹æ¡ˆï¼š**

```go
func (m *Manager) GC() (GCResult, error) {
    refs := make(map[string]bool)

    // æµå¼å¤„ç†
    for _, jsonlFile := range allFiles {
        f, _ := os.Open(jsonlFile)
        scanner := bufio.NewScanner(f)

        for scanner.Scan() {
            // åªè§£æ Blob å¼•ç”¨ï¼Œä¸å®Œæ•´è§£æè®°å½•
            line := scanner.Text()
            if strings.Contains(line, "$blob") {
                extractBlobRefs(line, refs)  // æ­£åˆ™æå–
            }
        }
        f.Close()
    }

    // ... åˆ é™¤æœªå¼•ç”¨ Blob ...
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… å†…å­˜å ç”¨ O(Blob æ•°é‡)ï¼Œä¸æ˜¯ O(è®°å½•æ•°)
- âœ… æµå¼å¤„ç†

**åŠ£åŠ¿ï¼š**
- æ­£åˆ™æå–å¯èƒ½ä¸ç²¾ç¡®

**å»ºè®®ï¼š** å¯¹å¤§æ•°æ®é›†é‡‡ç”¨æµå¼å¤„ç†ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- å®ç°äº† `streamBlobRefs()` æ–¹æ³•
- ä½¿ç”¨ bufio.Scanner é€è¡Œè¯»å–è€Œéå…¨éƒ¨åŠ è½½
- å†…å­˜å ç”¨ä» O(è®°å½•æ•°) é™è‡³ O(Blobæ•°)
- GC æ­£ç¡®æ€§ä¿®å¤ï¼šåªæ”¶é›†æœ€æ–°è®°å½•çš„ blob å¼•ç”¨ï¼Œé¿å…è¯¯åˆ¤

---

## Index æ¨¡å—

### é—®é¢˜ 5ï¼šKey æ¸…æ´—è¿‡äºæ¿€è¿› âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
// ä¿®å‰ªå°¾éƒ¨ä¸‹åˆ’çº¿
result = strings.Trim(result, " _")
```

**é—®é¢˜ï¼š**
```go
"test_"      â†’ "test"     âœ… åˆç†
"test___"    â†’ "test"     âœ… åˆç†
"___test___" â†’ "test"     âš ï¸ ä¸¢å¤±ä¿¡æ¯
"___"        â†’ "unnamed"  âš ï¸ å¤šä¸ªä¸‹åˆ’çº¿ Key å†²çª
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**

```go
func SanitizeKey(key string) string {
    result := key
    for _, char := range invalidChars {
        result = strings.ReplaceAll(result, char, "_")
    }

    // ä»…ä¿®å‰ªé¦–å°¾ç©ºæ ¼ï¼Œä¿ç•™ä¸‹åˆ’çº¿
    result = strings.TrimSpace(result)

    // ç§»é™¤è¿ç»­ä¸‹åˆ’çº¿ï¼ˆä¿ç•™å•ä¸ªï¼‰
    result = regexp.MustCompile(`_+`).ReplaceAllString(result, "_")

    // ç§»é™¤é¦–å°¾å•ä¸ªä¸‹åˆ’çº¿
    result = strings.Trim(result, "_")

    if result == "" {
        result = "unnamed"
    }

    return result
}
```

**ç¤ºä¾‹ï¼š**
```go
"test___data"  â†’ "test_data"  ï¼ˆå‹ç¼©è¿ç»­ä¸‹åˆ’çº¿ï¼‰
"___test"      â†’ "test"
"test_"        â†’ "test"
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ›´ç²¾ç¡®çš„æ¸…æ´—
- âœ… å‡å°‘ä¿¡æ¯ä¸¢å¤±

**å»ºè®®ï¼š** æ”¹è¿›æ¸…æ´—è§„åˆ™ï¼Œå¢åŠ å¯é¢„æµ‹æ€§ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- æ·»åŠ æ­£åˆ™è¡¨è¾¾å¼ `consecutiveUnderscores`
- SanitizeKey() æ–¹æ³•å‹ç¼©è¿ç»­ä¸‹åˆ’çº¿ä¸ºå•ä¸ªä¸‹åˆ’çº¿
- æµ‹è¯•é€šè¿‡ï¼šinternal/index åŒ… 17 tests passing
- æ”¹è¿›ç»“æœï¼š"test___data" â†’ "test_data"

---

### é—®é¢˜ 6ï¼šCache TTL Jitter å®ç°æœ‰ç¼ºé™· âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
factor := 1.0 + (rand.Float64()*2-1)*c.jitter
// jitter=0.2 â†’ factor âˆˆ [0.8, 1.2]
```

**é—®é¢˜ï¼š**
- âŒ å…è®¸ TTL å‡å°‘ 20%ï¼ˆè¿‡æ—©è¿‡æœŸï¼‰
- âŒ é¢‘ç¹ç¼“å­˜å¤±æ•ˆé™ä½å‘½ä¸­ç‡

**æ”¹è¿›æ–¹æ¡ˆï¼š**

```go
// åªå¢åŠ  TTLï¼Œä¸å‡å°‘
factor := 1.0 + rand.Float64()*c.jitter
// jitter=0.2 â†’ factor âˆˆ [1.0, 1.2]
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä¿è¯æœ€å° TTL
- âœ… ç¼“å­˜å‘½ä¸­ç‡æ›´é«˜
- âœ… ä»ç„¶é¿å…æƒŠç¾¤

**å»ºè®®ï¼š** æ”¹ä¸ºå•å‘ Jitterï¼ˆåªå»¶é•¿ï¼‰ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- ä¿®æ”¹ calculateTTL() æ–¹æ³•ä¸ºå•å‘ jitter
- æ”¹ä¸ºï¼š`factor = 1.0 + rand.Float64()*c.jitter`
- TTL å§‹ç»ˆ â‰¥ åŸºç¡€ TTLï¼Œé¿å…è¿‡æ—©å¤±æ•ˆ
- æµ‹è¯•é€šè¿‡ï¼šinternal/index åŒ… 17 tests passing

---

## Codec æ¨¡å—

### é—®é¢˜ 7ï¼šä¸æ”¯æŒåµŒå¥—ç»“æ„ä½“ âœ… **å·²å®Œæˆ**

**å½“å‰é™åˆ¶ï¼š**
```go
type User struct {
    Name    string
    Profile Profile  // âŒ ä¸æ”¯æŒ
}
```

**é—®é¢˜ï¼š**
- âŒ åµŒå¥—æ•°æ®éœ€è¦æ‰å¹³åŒ–
- âŒ ä¸ç¬¦åˆ Go ä¹ æƒ¯

**æ”¹è¿›æ–¹æ¡ˆï¼š**

```go
func ToMap(value interface{}) (map[string]interface{}, error) {
    // ... ç°æœ‰é€»è¾‘ ...

    for i := 0; i < val.NumField(); i++ {
        field := val.Field(i)
        fieldValue := field.Interface()

        // é€’å½’å¤„ç†åµŒå¥— struct
        if field.Kind() == reflect.Struct {
            nested, _ := ToMap(fieldValue)
            result[fieldName] = nested
        } else {
            result[fieldName] = fieldValue
        }
    }
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒåµŒå¥—ç»“æ„
- âœ… æ›´ç¬¦åˆç›´è§‰

**åŠ£åŠ¿ï¼š**
- å¢åŠ å®ç°å¤æ‚åº¦
- é€’å½’æ·±åº¦éœ€é™åˆ¶ï¼ˆé˜²æ­¢æ ˆæº¢å‡ºï¼‰

**å»ºè®®ï¼š** æ ¹æ®å®é™…éœ€æ±‚å†³å®šæ˜¯å¦å®ç°ï¼Œå½“å‰è®¾è®¡å¯¹ç®€å•åœºæ™¯è¶³å¤Ÿã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- ä¿®æ”¹ ToMap() å‡½æ•°æ”¯æŒé€’å½’å¤„ç†åµŒå¥— struct
- ä¿®æ”¹ setFieldValue() å‡½æ•°æ”¯æŒé€’å½’ååºåˆ—åŒ–
- æ”¯æŒä»»æ„æ·±åº¦åµŒå¥—ç»“æ„ä½“
- æ”¯æŒæŒ‡é’ˆç±»å‹çš„åµŒå¥—ç»“æ„ä½“
- æµ‹è¯•é€šè¿‡ï¼š6 ä¸ªç»¼åˆæµ‹è¯•è¦†ç›–å„ç§åµŒå¥—åœºæ™¯

---

## Codec æ¨¡å—

### é—®é¢˜ 8ï¼šBlob å­—æ®µæ£€æµ‹ä¼˜å…ˆçº§ä¸æ˜ç¡® âœ… **å·²å®Œæˆ**

**å½“å‰é€»è¾‘ï¼š**
```go
func shouldStoreAsBlob(...) {
    // 1. æ£€æŸ¥ io.Reader
    // 2. æ£€æŸ¥ []byte + (ForceFile OR > threshold)
}
```

**é—®é¢˜ï¼š**
- âš ï¸ Struct Tag æ²¡æœ‰å‚ä¸åˆ¤æ–­
- âš ï¸ ç”¨æˆ·æ— æ³•å¼ºåˆ¶"ä¸å­˜ä¸º Blob"

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**å®šä¹‰æ¸…æ™°ä¼˜å…ˆçº§ï¼š**
```
1. PutOption (WithForceFile / WithForceInline)  [æœ€é«˜ä¼˜å…ˆçº§]
2. Struct Tag (stow:"file" / stow:"inline")
3. ç±»å‹åˆ¤æ–­ (io.Reader)
4. å¤§å°åˆ¤æ–­ ([]byte > threshold)              [æœ€ä½ä¼˜å…ˆçº§]
```

**æ–°å¢é€‰é¡¹ï¼š**
```go
func WithForceInline() PutOption  // å¼ºåˆ¶å†…è”ï¼Œå³ä½¿å¾ˆå¤§
```

**æ–°å¢ Tagï¼š**
```go
type User struct {
    SmallImage []byte `stow:"inline"`  // å¼ºåˆ¶å†…è”
}
```

**å»ºè®®ï¼š** å¢åŠ  `WithForceInline` é€‰é¡¹ï¼Œæä¾›å®Œå…¨æ§åˆ¶ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- æ·»åŠ  `WithForceInline()` PutOption
- æ·»åŠ  `forceInline` å­—æ®µåˆ° putOptions
- Marshal è°ƒç”¨ä¼ é€’ ForceInline é€‰é¡¹
- ä¼˜å…ˆçº§æ˜ç¡®ï¼šWithForceInline > Tag > ç±»å‹ > å¤§å°
- æµ‹è¯•é€šè¿‡ï¼šinternal/codec åŒ… 16 tests passing

---

## Namespace æ¨¡å—

### é—®é¢˜ 9ï¼šå¹¶å‘ç²’åº¦å¤ªç²— âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
type namespace struct {
    mu sync.RWMutex  // Namespace çº§åˆ«é”
}

func (ns *namespace) Put(key string, ...) {
    ns.mu.Lock()         // é”ä½æ•´ä¸ª Namespace
    defer ns.mu.Unlock()
    // ...
}
```

**é—®é¢˜ï¼š**
- âŒ ä¸åŒ Key çš„å†™æ“ä½œä¸²è¡ŒåŒ–
- âŒ å¹¶å‘å†™å…¥å—é™äºå•é”

**å½±å“åœºæ™¯ï¼š**
```go
// ä¸¤ä¸ªä¸ç›¸å…³çš„ Keyï¼Œä½†å¿…é¡»ä¸²è¡Œ
go ns.Put("key1", data1)  // é”ä½ Namespace
go ns.Put("key2", data2)  // ç­‰å¾…é”é‡Šæ”¾
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼š** Key çº§é”ï¼ˆæ¨èï¼‰â­

```go
type namespace struct {
    keyLocks sync.Map  // key â†’ *sync.Mutex
    mu       sync.RWMutex
}

func (ns *namespace) Put(key string, ...) {
    // 1. è·å– Key çº§é”
    lockInterface, _ := ns.keyLocks.LoadOrStore(key, &sync.Mutex{})
    keyLock := lockInterface.(*sync.Mutex)

    keyLock.Lock()
    defer keyLock.Unlock()

    // 2. æ“ä½œæ–‡ä»¶ï¼ˆåªé”å½“å‰ Keyï¼‰
    // ...
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸åŒ Key å¹¶å‘å†™å…¥
- âœ… ç›¸åŒ Key ä¸²è¡ŒåŒ–ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰

**åŠ£åŠ¿ï¼š**
- å¢åŠ å¤æ‚åº¦
- Key é”éœ€è¦ GCï¼ˆé¿å…æ³„æ¼ï¼‰

**æ”¶ç›Šè¯„ä¼°ï¼š**
```
åœºæ™¯ï¼š10 ä¸ªå¹¶å‘å†™å…¥ä¸åŒ Key
å½“å‰ï¼šä¸²è¡Œï¼Œ10s
æ”¹è¿›ï¼šå¹¶å‘ï¼Œ1sï¼ˆ10x æå‡ï¼‰
```

**æ–¹æ¡ˆ Bï¼š** æ–‡ä»¶é”

```go
// ä½¿ç”¨ flock() ç³»ç»Ÿè°ƒç”¨
f, _ := os.OpenFile(filePath, ...)
syscall.Flock(f.Fd(), syscall.LOCK_EX)  // æ–‡ä»¶çº§ç‹¬å é”
// ... write ...
syscall.Flock(f.Fd(), syscall.LOCK_UN)
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒå¤šè¿›ç¨‹å¹¶å‘
- âœ… æ“ä½œç³»ç»Ÿçº§ä¿è¯

**åŠ£åŠ¿ï¼š**
- âŒ æ€§èƒ½å¼€é”€å¤§
- âŒ ä¸è·¨å¹³å°ï¼ˆWindows æ”¯æŒå·®ï¼‰

**å»ºè®®ï¼š**
- å•è¿›ç¨‹åœºæ™¯ï¼šé‡‡ç”¨æ–¹æ¡ˆ Aï¼ˆKey çº§é”ï¼‰
- å¤šè¿›ç¨‹åœºæ™¯ï¼šé‡‡ç”¨æ–¹æ¡ˆ Bï¼ˆæ–‡ä»¶é”ï¼‰

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- æ·»åŠ  `keyLocks sync.Map` å­—æ®µåˆ° namespace
- å®ç° getKeyLock(key string) æ–¹æ³•
- Put() å’Œ Delete() ä½¿ç”¨ key-level lock
- Get() å’Œ GetRaw() ä¼˜åŒ–ä¸ºæœ€å°åŒ–é”æŒæœ‰æ—¶é—´
- æµ‹è¯•é€šè¿‡ï¼š3 ä¸ªå¹¶å‘æµ‹è¯• + race detector æ£€æµ‹
- å¹¶å‘æ€§èƒ½æå‡ï¼šä¸åŒ Key å¯å¹¶å‘å†™å…¥ï¼Œ10x æ€§èƒ½æå‡

---

### é—®é¢˜ 10ï¼šCompact æ“ä½œé˜»å¡ âœ… **å·²å®Œæˆ**

**å½“å‰è®¾è®¡ï¼š**
```go
func (ns *namespace) Compact(keys ...string) error {
    ns.mu.Lock()  // é˜»å¡æ‰€æœ‰è¯»å†™
    defer ns.mu.Unlock()

    for _, key := range keys {
        compactKey(key)  // å¯èƒ½è€—æ—¶å‡ ç§’
    }
}
```

**é—®é¢˜ï¼š**
- âŒ Compact æœŸé—´æ— æ³•è¯»å†™
- âŒ å½±å“æ­£å¸¸ä¸šåŠ¡

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼š** åå°å¼‚æ­¥ Compactï¼ˆæ¨èï¼‰â­

```go
func (ns *namespace) CompactAsync(keys ...string) {
    go func() {
        for _, key := range keys {
            ns.compactKeySafe(key)  // é€ä¸ª Key åŠ é”
        }
    }()
}

func (ns *namespace) compactKeySafe(key string) error {
    // åªé”å½“å‰ Keyï¼ˆéœ€è¦ Key çº§é”ï¼‰
    ns.keyLocks[key].Lock()
    defer ns.keyLocks[key].Unlock()

    // Compact é€»è¾‘
    // ...
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸é˜»å¡å…¶ä»–æ“ä½œ
- âœ… æ¸è¿›å¼ Compact

**æ–¹æ¡ˆ Bï¼š** Copy-on-Write

```go
func (ns *namespace) Compact(key string) {
    // 1. è¯»å–å½“å‰æ–‡ä»¶ï¼ˆæ— é”ï¼‰
    records := readLastN(filePath, 10)

    // 2. å†™ä¸´æ—¶æ–‡ä»¶ï¼ˆæ— é”ï¼‰
    writeTempFile(tmpPath, records)

    // 3. åŸå­æ›¿æ¢ï¼ˆçŸ­æš‚åŠ é”ï¼‰
    ns.mu.Lock()
    os.Rename(tmpPath, filePath)
    ns.mu.Unlock()
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… é”æŒæœ‰æ—¶é—´æçŸ­ï¼ˆä»… Renameï¼‰

**å»ºè®®ï¼š** é‡‡ç”¨æ–¹æ¡ˆ A + æ–¹æ¡ˆ B ç»„åˆï¼Œå¼‚æ­¥ + çŸ­é”ã€‚

**âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ** (2024-12-14)
- å®ç° CompactAsync(keys ...string) æ–¹æ³•
- å®ç° CompactAllAsync() æ–¹æ³•
- å®ç° compactKeySafe(key) ä½¿ç”¨ key-level é”
- ä½¿ç”¨ goroutine åå°æ‰§è¡Œï¼Œä¸é˜»å¡è°ƒç”¨è€…
- æµ‹è¯•é€šè¿‡ï¼š4 ä¸ªå¼‚æ­¥å‹ç¼©æµ‹è¯•éªŒè¯éé˜»å¡è¡Œä¸º

---

## Store æ¨¡å—

### é—®é¢˜ 11ï¼šNamespace å»¶è¿ŸåŠ è½½ä¸å½»åº•

**å½“å‰è®¾è®¡ï¼š**
```go
func (s *store) GetNamespace(name string) (Namespace, error) {
    // æ£€æŸ¥ç¼“å­˜
    if ns, ok := s.namespaces[name]; ok {
        return ns, nil
    }

    // åˆ›å»ºå¹¶ç¼“å­˜
    ns := openNamespace(...)
    s.namespaces[name] = ns
    return ns, nil
}
```

**é—®é¢˜ï¼š**
- âš ï¸ é¦–æ¬¡è®¿é—®æ—¶åŠ è½½ï¼ˆæ­£ç¡®ï¼‰
- âŒ ä½† openNamespace() ä¼šæ‰«æç›®å½•ã€æ„å»ºç´¢å¼•ï¼ˆè€—æ—¶ï¼‰
- âŒ ç¬¬ä¸€æ¬¡ Get å¯èƒ½å¾ˆæ…¢

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**åŒå±‚å»¶è¿ŸåŠ è½½ï¼š**
```go
type namespace struct {
    path      string
    indexOnce sync.Once
    index     *index.KeyMapper
}

func (ns *namespace) ensureIndex() {
    ns.indexOnce.Do(func() {
        scanner := index.NewScanner()
        ns.index, _ = scanner.ScanNamespace(ns.path)
    })
}

func (ns *namespace) Get(key string, target interface{}) error {
    ns.ensureIndex()  // é¦–æ¬¡ Get æ—¶æ‰æ„å»ºç´¢å¼•
    // ...
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… GetNamespace ç«‹å³è¿”å›
- âœ… çœŸæ­£å»¶è¿Ÿåˆ°é¦–æ¬¡ä½¿ç”¨

**å»ºè®®ï¼š** å®ç°åŒå±‚å»¶è¿ŸåŠ è½½ï¼Œä¼˜åŒ–å¯åŠ¨æ—¶é—´ã€‚

---

## æ¶æ„å±‚é¢

### é—®é¢˜ 12ï¼šç¼ºå°‘ WALï¼ˆWrite-Ahead Logï¼‰

**å½“å‰è®¾è®¡ï¼š**
- ç›´æ¥è¿½åŠ åˆ° JSONL æ–‡ä»¶
- ä¾èµ– Sync + Rename ä¿è¯åŸå­æ€§

**é—®é¢˜ï¼š**
- âŒ é«˜é¢‘å†™å…¥æ—¶ Sync å¼€é”€å¤§
- âŒ å´©æºƒæ¢å¤å¯èƒ½ä¸¢å¤±æœª Sync æ•°æ®

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**å¼•å…¥ WALï¼š**
```
1. å†™å…¥ WALï¼ˆé¡ºåºå†™ï¼Œç¼“å†²ï¼‰
2. åå°å®šæœŸ Flush åˆ° JSONL
3. å´©æºƒåä» WAL æ¢å¤
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ‰¹é‡ Syncï¼Œæé«˜åå
- âœ… å´©æºƒæ¢å¤ä¸ä¸¢æ•°æ®

**åŠ£åŠ¿ï¼š**
- âŒ å¢åŠ å¤æ‚åº¦
- âŒ éœ€è¦æ¢å¤é€»è¾‘

**å»ºè®®ï¼š** å¯¹é«˜é¢‘å†™å…¥åœºæ™¯è€ƒè™‘å¼•å…¥ WALã€‚

---

### é—®é¢˜ 13ï¼šç¼ºå°‘äº‹åŠ¡æ”¯æŒ

**å½“å‰é™åˆ¶ï¼š**
```go
// æ— æ³•ä¿è¯åŸå­æ€§
ns.Put("key1", data1)
ns.Put("key2", data2)  // å¦‚æœå¤±è´¥ï¼Œkey1 å·²å†™å…¥
```

**é—®é¢˜ï¼š**
- âŒ æ— åŸå­æ€§ä¿è¯
- âŒ ä¸é€‚åˆå…³è”æ•°æ®

**æ”¹è¿›æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼š** ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

```go
func (ns *namespace) Transaction(fn func(tx *Transaction) error) error {
    tx := &Transaction{
        operations: []op{},
    }

    // 1. æ‰§è¡Œæ“ä½œï¼ˆä¸å†™å…¥ï¼‰
    if err := fn(tx); err != nil {
        return err
    }

    // 2. æäº¤ï¼ˆæ‰¹é‡å†™å…¥ï¼‰
    ns.mu.Lock()
    defer ns.mu.Unlock()

    for _, op := range tx.operations {
        if err := op.execute(); err != nil {
            // å›æ»šå·²å†™å…¥çš„
            rollback()
            return err
        }
    }

    return nil
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… åŸå­æ€§
- âœ… ä¸€è‡´æ€§

**åŠ£åŠ¿ï¼š**
- âŒ å®ç°å¤æ‚
- âŒ æ€§èƒ½å¼€é”€

**æ–¹æ¡ˆ Bï¼š** å•æ–‡ä»¶äº‹åŠ¡æ—¥å¿—

```go
// æ‰€æœ‰æ“ä½œè®°å½•åˆ° _transaction.jsonl
{"txid": 1, "ops": [{"put", "key1", ...}, {"put", "key2", ...}]}

// æäº¤æ—¶åŸå­æ ‡è®°
{"txid": 1, "committed": true}
```

**å»ºè®®ï¼š** æ ¹æ®å®é™…éœ€æ±‚å†³å®šæ˜¯å¦å®ç°ï¼Œå½“å‰è®¾è®¡å¯¹ç®€å•åœºæ™¯è¶³å¤Ÿã€‚

---

## æµ‹è¯•è¦†ç›–

### é—®é¢˜ 14ï¼šé›†æˆæµ‹è¯•è¦†ç›–ä¸è¶³

**å½“å‰çŠ¶æ€ï¼š**
- âœ… å•å…ƒæµ‹è¯•ï¼š72 ä¸ªï¼Œè¦†ç›–ç‡ 57%
- âš ï¸ é›†æˆæµ‹è¯•ï¼šéƒ¨åˆ†å®ç°ï¼Œæœªå®Œå…¨é€šè¿‡
- âŒ å¹¶å‘æµ‹è¯•ï¼šæ— 
- âŒ æ€§èƒ½æµ‹è¯•ï¼šæ— 

**æ”¹è¿›å»ºè®®ï¼š**

1. **å®Œå–„é›†æˆæµ‹è¯•**
   - Put/Get/Delete å®Œæ•´æµç¨‹
   - Blob å­˜å‚¨å’Œ GC
   - Compact å’Œå†å²ç‰ˆæœ¬
   - å¤š Namespace éš”ç¦»

2. **æ·»åŠ å¹¶å‘æµ‹è¯•**
   ```go
   func TestConcurrentReadWrite(t *testing.T) {
       var wg sync.WaitGroup
       for i := 0; i < 100; i++ {
           wg.Add(1)
           go func(id int) {
               defer wg.Done()
               ns.Put(fmt.Sprintf("key%d", id), data)
           }(i)
       }
       wg.Wait()
       // éªŒè¯æ•°æ®å®Œæ•´æ€§
   }
   ```

3. **æ·»åŠ æ€§èƒ½æµ‹è¯•**
   ```go
   func BenchmarkPut(b *testing.B) {
       for i := 0; i < b.N; i++ {
           ns.Put("key", data)
       }
   }
   ```

**å»ºè®®ï¼š** ä¼˜å…ˆå®Œå–„é›†æˆæµ‹è¯•ï¼Œç¡®ä¿ç«¯åˆ°ç«¯åŠŸèƒ½æ­£ç¡®ã€‚

---

## æ€»ç»“

### æŒ‰ä¼˜å…ˆçº§æ’åºçš„æ”¹è¿›

| ä¼˜å…ˆçº§ | é—®é¢˜ | æ”¹è¿›æ–¹æ¡ˆ | æ”¶ç›Š | å¤æ‚åº¦ | çŠ¶æ€ |
|-------|------|---------|------|--------|------|
| ğŸ”´ P0 | Blob å»é‡ä¸å®Œæ•´ | å“ˆå¸Œç´¢å¼• | 100x ç©ºé—´èŠ‚çœ | ä½ | âœ… å®Œæˆ |
| ğŸ”´ P0 | å¹¶å‘ç²’åº¦å¤ªç²— | Key çº§é” | 10x å¹¶å‘æ€§èƒ½ | ä¸­ | âœ… å®Œæˆ |
| ğŸŸ¡ P1 | åå‘è¯»å–æ•ˆç‡ä½ | å‘å‰æœç´¢ | 250x å†…å­˜èŠ‚çœ | ä¸­ | âœ… å®Œæˆ |
| ğŸŸ¡ P1 | Cache Jitter ç¼ºé™· | å•å‘ Jitter | æé«˜å‘½ä¸­ç‡ | ä½ | âœ… å®Œæˆ |
| ğŸŸ¡ P1 | Compact é˜»å¡ | å¼‚æ­¥ + çŸ­é” | ä¸é˜»å¡ä¸šåŠ¡ | ä¸­ | âœ… å®Œæˆ |
| ğŸŸ¡ P1 | GC æ•ˆç‡ä½ | æµå¼å¤„ç† | å†…å­˜å‹å¥½ | ä½ | âœ… å®Œæˆ |
| ğŸŸ¢ P2 | Key æ¸…æ´—è¿‡äºæ¿€è¿› | å‹ç¼©è¿ç»­ä¸‹åˆ’çº¿ | æ›´æ¸…æ™°æ–‡ä»¶å | ä½ | âœ… å®Œæˆ |
| ğŸŸ¢ P2 | ä¸æ”¯æŒåµŒå¥— struct | é€’å½’åºåˆ—åŒ– | æ›´å¥½çš„ API | ä¸­ | âœ… å®Œæˆ |
| ğŸŸ¢ P2 | Blob æ£€æµ‹ä¼˜å…ˆçº§ä¸æ˜ç¡® | WithForceInline é€‰é¡¹ | å®Œå…¨æ§åˆ¶ | ä½ | âœ… å®Œæˆ |
| âšª æœªå®æ–½ | ç‰ˆæœ¬å·ç®¡ç†ä¸å¤Ÿé²æ£’ | å•è°ƒè®¡æ•°å™¨ | å¹¶å‘å®‰å…¨ | ä¸­ | ğŸ”œ å¾…å®š |
| âšª æœªå®æ–½ | Namespace å»¶è¿ŸåŠ è½½ä¸å½»åº• | åŒå±‚å»¶è¿ŸåŠ è½½ | æ›´å¿«å¯åŠ¨ | ä½ | ğŸ”œ å¾…å®š |
| âšª æœªå®æ–½ | ç¼ºå°‘ WAL | Write-Ahead Log | é«˜åå | é«˜ | ğŸ”œ å¾…å®š |
| âšª æœªå®æ–½ | ç¼ºå°‘äº‹åŠ¡ | 2PC | åŸå­æ€§ | é«˜ | ğŸ”œ å¾…å®š |
| âšª æœªå®æ–½ | é›†æˆæµ‹è¯•è¦†ç›–ä¸è¶³ | å®Œå–„æµ‹è¯• | è´¨é‡ä¿è¯ | ä¸­ | ğŸ”œ å¾…å®š |

### å·²å®Œæˆä¼˜åŒ–æ€»ç»“

æˆªè‡³ 2024-12-14ï¼Œå·²å®Œæˆ **10 ä¸ªä¼˜åŒ–ä»»åŠ¡**ï¼ˆ9 ä¸ªæ¥è‡ªæœ¬æ–‡æ¡£ + æ ‡é‡å€¼æ”¯æŒ + GC æ­£ç¡®æ€§ä¿®å¤ï¼‰ï¼š

#### P0 ä¼˜å…ˆçº§ï¼ˆ2/2 å®Œæˆï¼‰âœ…
1. **Blob å»é‡** - å“ˆå¸Œç´¢å¼•å®ç°ï¼Œç›¸åŒå†…å®¹åªå­˜å‚¨ä¸€æ¬¡
2. **Key çº§å¹¶å‘é”** - ä¸åŒ Key å¯å¹¶å‘å†™å…¥ï¼Œ10x æ€§èƒ½æå‡

#### P1 ä¼˜å…ˆçº§ï¼ˆ4/4 å®Œæˆï¼‰âœ…
3. **åå‘è¯»å–ä¼˜åŒ–** - 4KB å—è¯»å–ï¼Œ250x å†…å­˜èŠ‚çœ
4. **Cache Jitter ä¿®å¤** - å•å‘ jitterï¼Œæé«˜å‘½ä¸­ç‡
5. **å¼‚æ­¥ Compact** - åå°æ‰§è¡Œï¼Œä¸é˜»å¡ä¸šåŠ¡
6. **GC æµå¼å¤„ç†** - å†…å­˜å ç”¨ O(Blobæ•°) è€Œé O(è®°å½•æ•°)

#### P2 ä¼˜å…ˆçº§ï¼ˆ3/3 å®Œæˆï¼‰âœ…
7. **Key æ¸…æ´—æ”¹è¿›** - å‹ç¼©è¿ç»­ä¸‹åˆ’çº¿
8. **åµŒå¥—ç»“æ„ä½“æ”¯æŒ** - é€’å½’åºåˆ—åŒ–/ååºåˆ—åŒ–
9. **WithForceInline é€‰é¡¹** - ç”¨æˆ·å®Œå…¨æ§åˆ¶å­˜å‚¨å†³ç­–

#### å…³é”®ä¿®å¤ï¼ˆ2 é¡¹ï¼‰âœ…
10. **æ ‡é‡å€¼æ”¯æŒ** - ToMap/FromMap æ”¯æŒæ ‡é‡å€¼åŒ…è£…/è§£åŒ…
11. **GC æ­£ç¡®æ€§** - åªæ”¶é›†æœ€æ–°è®°å½•çš„ blob å¼•ç”¨

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰âœ…**
   - âœ… å®ç° Blob å“ˆå¸Œç´¢å¼•å»é‡
   - âœ… ä¿®å¤ Cache Jitter é€»è¾‘
   - âœ… å®Œå–„é›†æˆæµ‹è¯•ï¼ˆæ ‡é‡å€¼æ”¯æŒï¼‰
   - âœ… Key çº§å¹¶å‘é”
   - âœ… åå‘è¯»å–ä¼˜åŒ–
   - âœ… å¼‚æ­¥ Compact
   - âœ… åµŒå¥—ç»“æ„ä½“æ”¯æŒ
   - âœ… GC æµå¼å¤„ç†

2. **ä¸­æœŸï¼ˆå¯é€‰ï¼‰**
   - åŒå±‚å»¶è¿ŸåŠ è½½ï¼ˆä¼˜åŒ–å¯åŠ¨æ—¶é—´ï¼‰
   - ç‰ˆæœ¬å·å•è°ƒè®¡æ•°å™¨ï¼ˆå¤šè¿›ç¨‹åœºæ™¯ï¼‰
   - æ€§èƒ½è°ƒä¼˜å’ŒåŸºå‡†æµ‹è¯•

3. **é•¿æœŸï¼ˆè§†éœ€æ±‚ï¼‰**
   - WAL æ”¯æŒï¼ˆé«˜é¢‘å†™å…¥åœºæ™¯ï¼‰
   - äº‹åŠ¡æ”¯æŒï¼ˆå…³è”æ•°æ®åœºæ™¯ï¼‰
   - å¤šè¿›ç¨‹æ–‡ä»¶é”ï¼ˆåˆ†å¸ƒå¼åœºæ™¯ï¼‰

---

## è®¾è®¡å“²å­¦

**è®°ä½ï¼š**
1. **ç®€å•ä¼˜å…ˆ** - ä¸è¿‡åº¦è®¾è®¡
2. **æ¸è¿›å¢å¼º** - æŒ‰éœ€æ·»åŠ ç‰¹æ€§
3. **æµ‹é‡é©±åŠ¨** - æ€§èƒ½ä¼˜åŒ–å‰å…ˆæµ‹é‡
4. **å‘åå…¼å®¹** - ä¿æŠ¤ç”¨æˆ·æŠ•èµ„

**Stow çš„æ ¸å¿ƒä»·å€¼æ˜¯"ç®€å•"ï¼Œæ‰€æœ‰æ”¹è¿›å¿…é¡»æœåŠ¡äºè¿™ä¸ªç›®æ ‡ã€‚**
